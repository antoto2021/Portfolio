<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Green Codex : Encyclop√©die & Collection</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #F0FDF4; }
        
        /* Utils */
        .chart-container { position: relative; width: 100%; height: 350px; margin: 0 auto; }
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Flowchart */
        .flow-box { position: relative; transition: all 0.3s; }
        .flow-arrow::after { content: '‚ñº'; position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%); color: #059669; font-size: 1.2rem; }
        @media (min-width: 768px) {
            .flow-arrow-md::after { content: '‚ñ∂'; top: 50%; right: -25px; bottom: auto; left: auto; transform: translateY(-50%); }
        }

        /* Interactive Cards */
        .card-interactive { cursor: pointer; transition: all 0.3s ease; }
        .card-interactive:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        
        /* Inputs */
        .input-field { width: 100%; padding: 12px; border-radius: 0.75rem; border: 1px solid #e2e8f0; background: #fff; outline: none; transition: border-color 0.2s; }
        .input-field:focus { border-color: #10b981; ring: 2px solid #10b981; }

        /* Edit Mode Styles */
        .editable-highlight { border: 2px dashed #F59E0B; cursor: text; padding: 2px; border-radius: 4px; position: relative; }
        .editable-highlight:hover::after { content: '‚úé √âditer'; position: absolute; top: -20px; right: 0; background: #F59E0B; color: white; font-size: 10px; padding: 2px 5px; border-radius: 4px; pointer-events: none; }
        .edit-mode-active body { border-top: 4px solid #F59E0B; }

        /* Titles Standardization */
        .section-title { font-size: 1.875rem; line-height: 2.25rem; font-weight: 700; color: #064E3B; margin-bottom: 1rem; }
    </style>
</head>
<body class="text-slate-800 pb-20">

    <!-- HEADER -->
    <header class="bg-gradient-to-r from-emerald-900 to-emerald-700 text-white p-6 shadow-lg sticky top-0 z-50 transition-colors" id="main-header">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div onclick="showView('home')" class="cursor-pointer">
                <h1 class="text-2xl md:text-3xl font-black tracking-tight">GREEN <span class="text-emerald-300">CODEX</span></h1>
                <p class="text-xs md:text-sm text-emerald-200">Encyclop√©die & Portfolio</p>
            </div>
            <div class="flex gap-2">
                <button onclick="toggleEditMode()" id="editModeBtn" class="bg-white/10 hover:bg-white/20 text-white px-3 py-2 rounded-lg text-sm font-bold transition flex items-center gap-2 border border-white/20">
                    <span>‚úèÔ∏è</span> <span class="hidden md:inline">Mode √âdition</span>
                </button>
                <button id="navBackBtn" onclick="showView('home')" class="hidden bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg text-sm font-bold transition backdrop-blur-sm">
                    ‚Üê Retour
                </button>
            </div>
        </div>
        <div id="edit-banner" class="hidden w-full bg-amber-500 text-white text-center text-xs font-bold py-1 mt-2 rounded">MODE √âDITION ACTIF - Cliquez sur les textes pour les modifier</div>
    </header>

    <main class="max-w-7xl mx-auto p-4 md:p-8 space-y-16">

        <!-- ==================== VIEW: HOME ==================== -->
        <div id="view-home" class="fade-in space-y-16">
            
            <!-- 1. INTRO -->
            <section class="bg-white rounded-2xl shadow-md p-8 border-l-8 border-emerald-600">
                <h2 class="section-title" data-editable="intro_title">1. L'Odyss√©e de la Plante</h2>
                <p class="text-lg leading-relaxed text-slate-600" data-editable="intro_text">
                    L'histoire du Cannabis est une symbiose mill√©naire entre l'homme et la nature. 
                    D'un c√¥t√©, la <strong>Weed</strong> (Fleur), cultiv√©e pour s'adapter aux climats vari√©s.
                    De l'autre, le <strong>Hash</strong> (R√©sine), l'art de concentrer l'essence de la plante.
                    Aujourd'hui, traditions et science se rencontrent.
                </p>
            </section>

            <!-- 2. MY COLLECTION -->
            <section id="my-collection-preview" class="bg-slate-900 rounded-2xl p-8 text-white relative overflow-hidden shadow-xl">
                <div class="absolute top-0 right-0 w-64 h-64 bg-emerald-500 rounded-full blur-[80px] opacity-20 pointer-events-none"></div>
                
                <div class="relative z-10">
                    <div class="flex justify-between items-end mb-6">
                        <div>
                            <h2 class="text-3xl font-bold text-white mb-2" data-editable="col_title">2. Ma Collection</h2>
                            <p class="text-slate-400" data-editable="col_sub">Votre carnet de d√©gustation personnel.</p>
                        </div>
                        <button onclick="showView('collection')" class="bg-emerald-500 hover:bg-emerald-400 text-white px-6 py-3 rounded-xl font-bold transition shadow-lg flex items-center gap-2">
                            <span>üìÇ</span> Ouvrir Portfolio
                        </button>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                            <span class="text-slate-400 text-xs uppercase font-bold">Total Entr√©es</span>
                            <div class="text-3xl font-black text-white" id="stats-total">0</div>
                        </div>
                        <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                            <span class="text-slate-400 text-xs uppercase font-bold">Weeds ü•¶</span>
                            <div class="text-3xl font-black text-emerald-400" id="stats-weed">0</div>
                        </div>
                        <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                            <span class="text-slate-400 text-xs uppercase font-bold">Hashs üç´</span>
                            <div class="text-3xl font-black text-amber-500" id="stats-hash">0</div>
                        </div>
                        <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                            <span class="text-slate-400 text-xs uppercase font-bold">Masse Totale</span>
                            <div class="text-3xl font-black text-purple-400" id="stats-mass">0g</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 3. FAMILLES -->
            <section>
                <div class="mb-8 border-b border-slate-200 pb-4">
                    <h2 class="section-title" data-editable="fam_title">3. Les Familles Fondamentales</h2>
                    <p class="text-slate-600" data-editable="fam_desc">Explorez les standards de l'industrie.</p>
                </div>

                <!-- Hash -->
                <h3 class="text-xl font-bold text-slate-700 mb-4 flex items-center">üß™ Concentr√©s (Hash)</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
                    <div onclick="showDetail('hash_dry')" class="bg-white p-6 rounded-xl shadow-md border-t-4 border-amber-500 card-interactive group">
                        <div class="flex justify-between"> <div class="text-4xl mb-4">üèúÔ∏è</div> <span class="text-xs font-bold text-amber-600 bg-amber-50 px-2 py-1 rounded h-fit">TRADITION</span> </div>
                        <h3 class="text-xl font-bold text-slate-800 group-hover:text-amber-600">Dry Sift</h3>
                    </div>
                    <div onclick="showDetail('hash_water')" class="bg-white p-6 rounded-xl shadow-md border-t-4 border-blue-500 card-interactive group">
                        <div class="flex justify-between"> <div class="text-4xl mb-4">‚ùÑÔ∏è</div> <span class="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded h-fit">PURET√â</span> </div>
                        <h3 class="text-xl font-bold text-slate-800 group-hover:text-blue-600">Ice-O-Lator</h3>
                    </div>
                    <div onclick="showDetail('hash_rosin')" class="bg-white p-6 rounded-xl shadow-md border-t-4 border-purple-500 card-interactive group">
                        <div class="flex justify-between"> <div class="text-4xl mb-4">üî•</div> <span class="text-xs font-bold text-purple-600 bg-purple-50 px-2 py-1 rounded h-fit">MODERNE</span> </div>
                        <h3 class="text-xl font-bold text-slate-800 group-hover:text-purple-600">Rosin</h3>
                    </div>
                </div>

                <!-- Weed -->
                <h3 class="text-xl font-bold text-slate-700 mb-4 flex items-center">üå± Fleur (Weed)</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div onclick="showDetail('weed_indica')" class="bg-white p-6 rounded-xl shadow-md border-t-4 border-indigo-500 card-interactive group">
                        <div class="flex justify-between"> <div class="text-4xl mb-4">üèîÔ∏è</div> <span class="text-xs font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded h-fit">RELAX</span> </div>
                        <h3 class="text-xl font-bold text-slate-800 group-hover:text-indigo-600">Indica</h3>
                    </div>
                    <div onclick="showDetail('weed_sativa')" class="bg-white p-6 rounded-xl shadow-md border-t-4 border-yellow-500 card-interactive group">
                        <div class="flex justify-between"> <div class="text-4xl mb-4">‚òÄÔ∏è</div> <span class="text-xs font-bold text-yellow-600 bg-yellow-50 px-2 py-1 rounded h-fit">√âNERGIE</span> </div>
                        <h3 class="text-xl font-bold text-slate-800 group-hover:text-yellow-600">Sativa</h3>
                    </div>
                    <div onclick="showDetail('weed_exotic')" class="bg-white p-6 rounded-xl shadow-md border-t-4 border-pink-500 card-interactive group">
                        <div class="flex justify-between"> <div class="text-4xl mb-4">üß¨</div> <span class="text-xs font-bold text-pink-600 bg-pink-50 px-2 py-1 rounded h-fit">HYBRIDE</span> </div>
                        <h3 class="text-xl font-bold text-slate-800 group-hover:text-pink-600">Exotics</h3>
                    </div>
                </div>
            </section>

            <!-- 4. POTENCY -->
            <section class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="section-title" data-editable="potency_title">4. √âchelle de Puissance</h2>
                    <div class="chart-container">
                        <canvas id="potencyChart"></canvas>
                    </div>
                </div>
                <div class="lg:col-span-1 bg-emerald-50 border-l-4 border-emerald-500 p-6 rounded-r-xl">
                    <h4 class="font-bold text-emerald-900 text-lg mb-2" data-editable="didyouknow_title">Le Saviez-vous ?</h4>
                    <p class="text-sm text-emerald-800" data-editable="didyouknow_text">
                        L'effet ressenti d√©pend de l'<strong>Effet d'Entourage</strong> : la synergie entre cannabino√Ødes et terp√®nes.
                    </p>
                </div>
            </section>

            <!-- 5. COMPARATOR -->
            <section class="bg-white p-8 rounded-2xl shadow-xl border border-slate-100">
                <h2 class="section-title" data-editable="comp_title">5. Comparateur</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="space-y-6 flex flex-col justify-center bg-slate-50 p-6 rounded-xl">
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">Produit A</label>
                            <select id="selectA" class="w-full p-3 rounded border border-slate-300 bg-white outline-none" onchange="updateComparator()"></select>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">Produit B</label>
                            <select id="selectB" class="w-full p-3 rounded border border-slate-300 bg-white outline-none" onchange="updateComparator()"></select>
                        </div>
                    </div>
                    <div class="md:col-span-2">
                        <div class="chart-container">
                            <canvas id="comparatorRadar"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 6. MATRIX -->
            <section class="bg-white p-6 rounded-xl shadow-md">
                <h2 class="section-title" data-editable="matrix_title">6. Matrice : Texture vs Puret√©</h2>
                <p class="text-slate-600 mb-4" data-editable="matrix_desc">Le grand spectre des textures.</p>
                <div id="globalMatrixPlot" class="w-full h-[500px]"></div>
            </section>

            <!-- 7. LEXICON -->
            <section class="bg-slate-900 text-slate-300 p-8 rounded-xl">
                <h2 class="section-title !text-white" data-editable="lex_title">7. Lexique</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6 text-sm">
                    <div><strong class="block text-emerald-400">Trichomes</strong>Glandes de r√©sine.</div>
                    <div><strong class="block text-emerald-400">Terp√®nes</strong>Mol√©cules aromatiques.</div>
                    <div><strong class="block text-emerald-400">Full Melt</strong>Fond sans r√©sidu.</div>
                    <div><strong class="block text-emerald-400">Solventless</strong>Extraction m√©canique.</div>
                </div>
            </section>

            <!-- DYNAMIC SECTIONS CONTAINER -->
            <div id="custom-sections-container" class="space-y-16"></div>

            <!-- ADD SECTION BUTTON (Edit Mode Only) -->
            <div id="add-section-area" class="hidden text-center py-10 border-t border-dashed border-slate-300">
                <button onclick="addNewSection()" class="bg-amber-500 hover:bg-amber-600 text-white px-6 py-3 rounded-full font-bold shadow-lg transition transform hover:scale-105">
                    + Ajouter une Section
                </button>
            </div>
        </div>


        <!-- ==================== VIEW: DETAIL (ENCYCLOPEDIA) ==================== -->
        <div id="view-detail" class="hidden fade-in space-y-8 pb-12">
            <div id="detail-header" class="bg-white p-8 rounded-2xl shadow-lg border-t-8">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <span id="detail-badge" class="px-3 py-1 rounded-full text-sm font-bold uppercase tracking-wider mb-2 inline-block">Badge</span>
                        <h2 id="detail-title" class="text-4xl md:text-5xl font-black text-slate-800">Title</h2>
                    </div>
                    <div class="text-5xl opacity-20" id="detail-icon">icon</div>
                </div>
                <p id="detail-desc" class="text-lg text-slate-600 leading-relaxed border-l-4 border-slate-200 pl-4">Desc</p>
            </div>
            <section class="bg-slate-800 text-white p-8 rounded-2xl shadow-xl">
                <h3 class="text-2xl font-bold mb-6">Processus</h3>
                <div id="detail-flow" class="grid grid-cols-1 md:grid-cols-4 gap-4 text-center"></div>
            </section>
            <section class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <div class="chart-container"><canvas id="detailRadarChart"></canvas></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <div class="chart-container"><canvas id="detailBarChart"></canvas></div>
                </div>
            </section>
        </div>


        <!-- ==================== VIEW: COLLECTION (MANAGER) ==================== -->
        <div id="view-collection" class="hidden fade-in pb-20">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-emerald-900">Mon Portfolio</h2>
                <button onclick="openCollectionForm()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg font-bold shadow-md hover:bg-emerald-500 transition flex items-center gap-2">
                    + Ajouter
                </button>
            </div>
            <div id="collection-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            <div id="empty-state" class="hidden text-center py-20 text-slate-400">
                <div class="text-6xl mb-4">üì≠</div>
                <p>Votre collection est vide.</p>
            </div>
        </div>

    </main>


    <!-- MODAL FORM COLLECTION -->
    <div id="collection-modal" class="hidden fixed inset-0 z-[100] bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl p-6 max-h-[90vh] overflow-y-auto">
            <h3 id="modal-title" class="text-2xl font-bold text-slate-800 mb-6">Ajouter √† la collection</h3>
            <form id="collection-form" onsubmit="handleCollectionSubmit(event)" class="space-y-4">
                <input type="hidden" name="editIndex" id="editIndex" value="-1">
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-slate-500 uppercase">Cat√©gorie</label>
                        <select name="category" id="inp-category" class="input-field" onchange="toggleFormFields(this.value)">
                            <option value="weed">ü•¶ Weed</option>
                            <option value="hash">üç´ Hash</option>
                        </select>
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-slate-500 uppercase">Quantit√© (g)</label>
                        <input type="number" step="0.1" name="quantity" id="inp-quantity" class="input-field" placeholder="ex: 3.5">
                    </div>
                </div>

                <div id="hash-fields" class="hidden bg-amber-50 p-3 rounded-lg border border-amber-100 mb-2">
                    <label class="text-xs font-bold text-amber-600 uppercase mb-1">Type de Hash</label>
                    <input type="text" name="hashType" id="inp-hashType" class="input-field border-amber-200" placeholder="ex: Dry Sift...">
                </div>

                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-500 uppercase">Vari√©t√© (Strain)</label>
                    <input type="text" name="strain" id="inp-strain" class="input-field font-bold" placeholder="ex: Gelato #41" required>
                </div>
                
                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-500 uppercase">Nom Commercial</label>
                    <input type="text" name="commercialName" id="inp-commercialName" class="input-field" placeholder="ex: Blue Magic">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-slate-500 uppercase">Pays</label>
                        <input type="text" name="country" id="inp-country" class="input-field" placeholder="ex: Espagne">
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-slate-500 uppercase">Prix (‚Ç¨)</label>
                        <input type="number" name="price" id="inp-price" class="input-field" placeholder="ex: 50">
                    </div>
                </div>

                <!-- Photos (Multiple) -->
                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-500 uppercase">Photos (Max 3)</label>
                    <div class="flex gap-2 items-center">
                        <label class="w-20 h-20 border-2 border-dashed border-slate-300 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:bg-slate-50 transition text-slate-400">
                            <span class="text-2xl">+</span>
                            <input type="file" id="photo-input" class="hidden" accept="image/*" multiple onchange="handlePhotos(this)">
                        </label>
                        <div id="photo-preview-list" class="flex gap-2"></div>
                    </div>
                </div>

                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeCollectionForm()" class="flex-1 py-3 rounded-xl border border-slate-300 text-slate-500 font-bold">Annuler</button>
                    <button type="submit" class="flex-1 py-3 rounded-xl bg-emerald-600 text-white font-bold hover:bg-emerald-500">Sauvegarder</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // --- CORE DATA & STATE ---
        const masterData = {
            hash_dry: { name: "Dry Sift", color: "amber", hex: "#D97706", badge: "Tradition", icon: "üèúÔ∏è", desc: "Tamisage m√©canique ancestral.", process: [{t:"S√©chage",d:"Plante affin√©e"},{t:"Tamisage",d:"Frottement"},{t:"Collection",d:"Poudre"},{t:"Presse",d:"Chaleur"}], radar: [30,90,70,50,60], metrics: [20,50,40,30], metricsLabels: ['Rendement','Puissance','Prix','Tech'], matrix: {x:45,y:9} },
            hash_water: { name: "Ice-O-Lator", color: "blue", hex: "#2563EB", badge: "Puret√©", icon: "‚ùÑÔ∏è", desc: "Extraction eau glac√©e + Fresh Frozen.", process: [{t:"Cong√©lation",d:"-40¬∞C"},{t:"Lavage",d:"Eau+Glace"},{t:"Filtre",d:"Sacs"},{t:"S√©chage",d:"Lyophilisation"}], radar: [90,30,60,95,85], metrics: [10,75,90,80], metricsLabels: ['Rendement','Puissance','Prix','Tech'], matrix: {x:70,y:6} },
            hash_rosin: { name: "Rosin", color: "purple", hex: "#9333EA", badge: "Excellence", icon: "üî•", desc: "Pression et chaleur uniquement.", process: [{t:"Mat√©riel",d:"Hash 6*"},{t:"Sac",d:"25u Nylon"},{t:"Presse",d:"Hydraulique"},{t:"Cure",d:"Cold Cure"}], radar: [85,50,80,90,95], metrics: [15,85,100,60], metricsLabels: ['Rendement','Puissance','Prix','Tech'], matrix: {x:85,y:3} },
            weed_indica: { name: "Indica (Kush)", color: "indigo", hex: "#4F46E5", badge: "Relax", icon: "üèîÔ∏è", desc: "Montagnes, effet lourd.", process: [{t:"Origine",d:"Hindu Kush"},{t:"Structure",d:"Buisson"},{t:"Flo",d:"8 sem"},{t:"Effet",d:"Physique"}], radar: [20,80,90,60,40], metrics: [80,22,50,90], metricsLabels: ['Rendement','THC','Taille','Facilit√©'], matrix: {x:20,y:10} },
            weed_sativa: { name: "Sativa (Haze)", color: "yellow", hex: "#D97706", badge: "Energie", icon: "‚òÄÔ∏è", desc: "Tropiques, effet high.", process: [{t:"Origine",d:"Equateur"},{t:"Structure",d:"G√©ante"},{t:"Flo",d:"12+ sem"},{t:"Effet",d:"C√©r√©bral"}], radar: [60,40,20,70,40], metrics: [90,18,100,60], metricsLabels: ['Rendement','THC','Taille','Facilit√©'], matrix: {x:18,y:10} },
            weed_exotic: { name: "Exotics", color: "pink", hex: "#DB2777", badge: "Hybride", icon: "üß¨", desc: "Breeding US moderne.", process: [{t:"Origine",d:"Indoor"},{t:"Structure",d:"Optimis√©e"},{t:"Flo",d:"9 sem"},{t:"Effet",d:"Mixte"}], radar: [80,50,60,80,50], metrics: [75,28,60,70], metricsLabels: ['Rendement','THC','Taille','Facilit√©'], matrix: {x:28,y:10} }
        };

        let collection = JSON.parse(localStorage.getItem('green_codex_collection') || '[]');
        let contentMap = JSON.parse(localStorage.getItem('green_codex_content') || '{}');
        let customSections = JSON.parse(localStorage.getItem('green_codex_custom_sections') || '[]');
        
        let isEditMode = false;
        let currentPhotos = [];

        // --- NAVIGATION ---
        function showView(viewId) {
            document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${viewId}`).classList.remove('hidden');
            document.getElementById('navBackBtn').classList.toggle('hidden', viewId === 'home');
            document.getElementById('editModeBtn').classList.toggle('hidden', viewId !== 'home'); // Edit mode only on home
            window.scrollTo(0,0);
            if(viewId === 'collection') renderCollectionList();
        }

        // --- EDIT MODE LOGIC ---
        function toggleEditMode() {
            isEditMode = !isEditMode;
            document.body.classList.toggle('edit-mode-active', isEditMode);
            document.getElementById('edit-banner').classList.toggle('hidden', !isEditMode);
            document.getElementById('editModeBtn').classList.toggle('bg-amber-500', isEditMode);
            document.getElementById('add-section-area').classList.toggle('hidden', !isEditMode);
            
            // Toggle Content Editable triggers
            document.querySelectorAll('[data-editable]').forEach(el => {
                if(isEditMode) {
                    el.classList.add('editable-highlight');
                    el.onclick = (e) => editContent(e.target);
                } else {
                    el.classList.remove('editable-highlight');
                    el.onclick = null;
                }
            });

            // Toggle Custom Sections Delete buttons
            renderCustomSections();
        }

        function editContent(el) {
            if(!isEditMode) return;
            const key = el.getAttribute('data-editable');
            const newText = prompt("Modifier le texte :", el.innerText);
            if(newText !== null) {
                el.innerText = newText;
                contentMap[key] = newText;
                localStorage.setItem('green_codex_content', JSON.stringify(contentMap));
            }
        }

        function loadSavedContent() {
            document.querySelectorAll('[data-editable]').forEach(el => {
                const key = el.getAttribute('data-editable');
                if(contentMap[key]) el.innerText = contentMap[key];
            });
            renderCustomSections();
        }

        function addNewSection() {
            const title = prompt("Titre de la nouvelle section :");
            if(!title) return;
            const text = prompt("Contenu du texte :");
            if(!text) return;
            
            customSections.push({ title, text, id: Date.now() });
            localStorage.setItem('green_codex_custom_sections', JSON.stringify(customSections));
            renderCustomSections();
        }

        function deleteCustomSection(id) {
            if(!confirm("Supprimer cette section ?")) return;
            customSections = customSections.filter(s => s.id !== id);
            localStorage.setItem('green_codex_custom_sections', JSON.stringify(customSections));
            renderCustomSections();
        }

        function renderCustomSections() {
            const container = document.getElementById('custom-sections-container');
            container.innerHTML = '';
            customSections.forEach((sec, index) => {
                // FIXED STYLE: Matches standard sections (border-emerald-600, section-title class)
                const html = `
                    <section class="bg-white rounded-2xl shadow-md p-8 border-l-8 border-emerald-600 relative group animate-fade-in">
                        ${isEditMode ? `<button onclick="deleteCustomSection(${sec.id})" class="absolute top-4 right-4 text-red-500 font-bold border border-red-200 px-3 py-1 rounded hover:bg-red-50 text-xs transition">Supprimer</button>` : ''}
                        <h2 class="section-title">${index + 8}. ${sec.title}</h2>
                        <p class="text-lg leading-relaxed text-slate-600">${sec.text}</p>
                    </section>
                `;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        // --- CHARTS & COMPARATOR (UNCHANGED LOGIC) ---
        const initCharts = () => {
            new Chart(document.getElementById('potencyChart'), {
                type: 'bar',
                data: { labels: ['Sativa', 'Indica', 'Exotic', 'Dry Sift', 'Ice-O-Lator', 'Rosin', 'BHO'], datasets: [{ label: '% THC', data: [15,20,28,40,65,75,90], backgroundColor: ['#10B981','#10B981','#10B981','#D97706','#2563EB','#9333EA','#64748B'], borderRadius: 4 }] },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: {legend:false} }
            });
            const sA = document.getElementById('selectA'), sB = document.getElementById('selectB');
            Object.keys(masterData).forEach(k => { sA.add(new Option(masterData[k].name, k)); sB.add(new Option(masterData[k].name, k)); });
            sA.value = "weed_sativa"; sB.value = "hash_rosin";
            updateComparator();
            const trace = { x: Object.values(masterData).map(d => d.matrix.x), y: Object.values(masterData).map(d => d.matrix.y), text: Object.values(masterData).map(d => d.name), mode: 'markers+text', type: 'scatter', textposition: 'top center', marker: { size: 30, color: Object.values(masterData).map(d => d.hex) } };
            Plotly.newPlot('globalMatrixPlot', [trace], { xaxis: {title:'Puret√©', range:[0,100]}, yaxis: {title:'Solidit√©', range:[0,12]}, margin:{t:20,l:40}, paper_bgcolor:'rgba(0,0,0,0)', plot_bgcolor:'rgba(0,0,0,0)' }, {displayModeBar:false});
        };
        let comparatorChart;
        function updateComparator() {
            const dA = masterData[document.getElementById('selectA').value], dB = masterData[document.getElementById('selectB').value];
            if(comparatorChart) comparatorChart.destroy();
            comparatorChart = new Chart(document.getElementById('comparatorRadar'), {
                type: 'radar',
                data: { labels: ['Fruit√©', 'Terreux', 'Physique', 'Odeur', 'Intensit√©'], datasets: [ { label: dA.name, data: dA.radar, borderColor: '#3B82F6', backgroundColor: 'rgba(59,130,246,0.2)' }, { label: dB.name, data: dB.radar, borderColor: '#EC4899', backgroundColor: 'rgba(236,72,153,0.2)' } ] },
                options: { responsive: true, maintainAspectRatio: false, scales: { r: { suggestedMin:0, suggestedMax:100 } } }
            });
        }
        function showDetail(key) {
            const d = masterData[key];
            showView('detail');
            document.getElementById('detail-header').className = `bg-white p-8 rounded-2xl shadow-lg border-t-8 border-${d.color}-500`;
            document.getElementById('detail-badge').innerText = d.badge;
            document.getElementById('detail-badge').className = `px-3 py-1 rounded-full text-sm font-bold uppercase mb-2 inline-block bg-${d.color}-100 text-${d.color}-800`;
            document.getElementById('detail-title').innerText = d.name;
            document.getElementById('detail-title').className = `text-4xl md:text-5xl font-black text-${d.color}-900`;
            document.getElementById('detail-icon').innerText = d.icon;
            document.getElementById('detail-desc').innerText = d.desc;
            document.getElementById('detail-desc').className = `text-lg text-slate-600 border-l-4 border-${d.color}-200 pl-4`;
            document.getElementById('detail-flow').innerHTML = d.process.map(s => `<div class="bg-slate-700 p-4 rounded-lg border border-slate-600"><div class="text-xs text-${d.color}-400 font-mono uppercase">${s.t}</div><div class="font-bold">${s.d}</div></div>`).join('');
            // Charts (Simplified re-creation)
            const cvs1 = document.getElementById('detailRadarChart'); const cvs2 = document.getElementById('detailBarChart');
            if(cvs1.chart) cvs1.chart.destroy(); if(cvs2.chart) cvs2.chart.destroy();
            cvs1.chart = new Chart(cvs1, { type: 'radar', data: { labels: ['Fruit√©','Terreux','Physique','Odeur','Intensit√©'], datasets: [{ label: d.name, data: d.radar, backgroundColor: `${d.hex}33`, borderColor: d.hex, fill: true }] }, options: { maintainAspectRatio: false, plugins: {legend:false} } });
            cvs2.chart = new Chart(cvs2, { type: 'bar', data: { labels: ['Rendement','Puissance','Prix','Tech'], datasets: [{ data: d.metrics, backgroundColor: d.hex, borderRadius: 6 }] }, options: { maintainAspectRatio: false, plugins: {legend:false}, scales: {y:{max:100}} } });
        }

        // --- COLLECTION MANAGER (MULTI PHOTOS & EDIT) ---

        function saveCollection() {
            localStorage.setItem('green_codex_collection', JSON.stringify(collection));
            updateDashboardStats();
            renderCollectionList();
        }

        function updateDashboardStats() {
            document.getElementById('stats-total').innerText = collection.length;
            document.getElementById('stats-weed').innerText = collection.filter(i => i.category === 'weed').length;
            document.getElementById('stats-hash').innerText = collection.filter(i => i.category === 'hash').length;
            // UPDATE: Mass instead of Price
            const totalMass = collection.reduce((acc, curr) => acc + (parseFloat(curr.quantity) || 0), 0);
            document.getElementById('stats-mass').innerText = totalMass.toFixed(1) + 'g';
        }

        function getFlag(c) { 
            if(!c) return 'üè≥Ô∏è'; 
            const m = {'france':'üá´üá∑','espagne':'üá™üá∏','usa':'üá∫üá∏','cali':'üá∫üá∏','maroc':'üá≤üá¶','suisse':'üá®üá≠','italie':'üáÆüáπ','canada':'üá®üá¶','uk':'üá¨üáß','allemagne':'üá©üá™','thailande':'üáπüá≠'};
            for(let k in m) if(c.toLowerCase().includes(k)) return m[k];
            return 'üè≥Ô∏è';
        }

        function renderCollectionList() {
            const container = document.getElementById('collection-list');
            container.innerHTML = '';
            document.getElementById('empty-state').classList.toggle('hidden', collection.length > 0);
            
            collection.forEach((item, index) => {
                const photosHtml = item.photos && item.photos.length ? 
                    `<img src="${item.photos[0]}" class="w-full h-full object-cover">` : 
                    `<div class="w-full h-full flex items-center justify-center text-3xl opacity-30">${item.category==='hash'?'üç´':'ü•¶'}</div>`;
                
                const html = `
                <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4 flex gap-4 relative group hover:border-emerald-300 transition">
                    <div class="w-20 h-20 rounded-lg bg-slate-100 flex-shrink-0 overflow-hidden relative">
                        ${photosHtml}
                        ${item.photos && item.photos.length > 1 ? `<span class="absolute bottom-0 right-0 bg-black/50 text-white text-[10px] px-1">+${item.photos.length-1}</span>` : ''}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-start">
                            <h3 class="font-bold text-slate-800 truncate pr-2">${item.strain}</h3>
                            <span class="text-xl">${getFlag(item.country)}</span>
                        </div>
                        <p class="text-xs text-slate-500 font-bold uppercase mb-1">${item.commercialName || item.farm || 'Inconnu'}</p>
                        ${item.type ? `<span class="bg-amber-100 text-amber-800 text-[10px] px-1.5 py-0.5 rounded border border-amber-200 block w-fit mb-1">${item.type}</span>` : ''}
                        <div class="flex items-center gap-2 mt-2">
                             <span class="bg-emerald-50 text-emerald-700 text-xs px-2 py-1 rounded font-bold">${item.quantity}g</span>
                             
                             <div class="ml-auto flex gap-1">
                                <button onclick="openCollectionForm(${index})" class="text-blue-400 hover:text-blue-600 p-1"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                                <button onclick="deleteItem(${index})" class="text-red-400 hover:text-red-600 p-1"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                             </div>
                        </div>
                    </div>
                </div>`;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        // --- FORM HANDLING (MULTI PHOTOS & EDIT) ---

        function openCollectionForm(editIndex = -1) {
            const form = document.getElementById('collection-form');
            form.reset();
            document.getElementById('editIndex').value = editIndex;
            document.getElementById('modal-title').innerText = editIndex === -1 ? "Ajouter" : "Modifier";
            currentPhotos = [];
            
            if(editIndex > -1) {
                const item = collection[editIndex];
                document.getElementById('inp-category').value = item.category;
                document.getElementById('inp-quantity').value = item.quantity;
                document.getElementById('inp-strain').value = item.strain;
                document.getElementById('inp-commercialName').value = item.commercialName;
                document.getElementById('inp-country').value = item.country;
                if(item.farm) document.getElementById('inp-farm').value = item.farm; // Fixed missing ID
                document.getElementById('inp-price').value = item.price;
                if(item.type) document.getElementById('inp-hashType').value = item.type;
                toggleFormFields(item.category);
                
                // Load existing photos
                if(item.photos) currentPhotos = [...item.photos];
            } else {
                toggleFormFields('weed');
            }
            
            renderPhotoPreviews();
            document.getElementById('collection-modal').classList.remove('hidden');
        }

        function closeCollectionForm() {
            document.getElementById('collection-modal').classList.add('hidden');
        }

        function toggleFormFields(category) {
            document.getElementById('hash-fields').classList.toggle('hidden', category !== 'hash');
        }

        function handlePhotos(input) {
            if (input.files) {
                const remainingSlots = 3 - currentPhotos.length;
                if(remainingSlots <= 0) { alert("Max 3 photos !"); return; }
                
                const files = Array.from(input.files).slice(0, remainingSlots);
                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        currentPhotos.push(e.target.result);
                        renderPhotoPreviews();
                    };
                    reader.readAsDataURL(file);
                });
            }
        }

        function removePhoto(idx) {
            currentPhotos.splice(idx, 1);
            renderPhotoPreviews();
        }

        function renderPhotoPreviews() {
            const container = document.getElementById('photo-preview-list');
            container.innerHTML = currentPhotos.map((src, i) => `
                <div class="w-20 h-20 rounded-xl relative overflow-hidden group">
                    <img src="${src}" class="w-full h-full object-cover">
                    <button type="button" onclick="removePhoto(${i})" class="absolute top-0 right-0 bg-red-500 text-white text-xs p-1 opacity-0 group-hover:opacity-100">X</button>
                </div>
            `).join('');
        }

        function handleCollectionSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const idx = parseInt(document.getElementById('editIndex').value);
            
            const newItem = {
                category: formData.get('category'),
                quantity: formData.get('quantity'),
                strain: formData.get('strain'),
                commercialName: formData.get('commercialName'),
                type: formData.get('hashType'),
                country: formData.get('country'),
                price: formData.get('price'),
                photos: currentPhotos, // Array
                date: new Date().toISOString()
            };
            
            if(idx > -1) collection[idx] = newItem; // Edit
            else collection.unshift(newItem); // Add
            
            saveCollection();
            closeCollectionForm();
        }

        function deleteItem(index) {
            if(confirm('Supprimer ?')) {
                collection.splice(index, 1);
                saveCollection();
            }
        }

        window.addEventListener('load', () => {
            initCharts();
            loadSavedContent();
            updateDashboardStats();
        });

    </script>
</body>
</html>

