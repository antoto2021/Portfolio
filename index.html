<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-title" content="Green Codex">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="logo appli.png">
    <link rel="icon" type="image/png" href="logo appli.png">
    <title>Green Codex</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #F0FDF4; }
        
        /* Utils */
        .chart-container { position: relative; width: 100%; height: 350px; margin: 0 auto; }
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Interactive Cards */
        .card-interactive { cursor: pointer; transition: all 0.3s ease; }
        .card-interactive:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        
        /* Inputs */
        .input-field { width: 100%; padding: 12px; border-radius: 0.75rem; border: 1px solid #e2e8f0; background: #fff; outline: none; transition: border-color 0.2s; }
        .input-field:focus { border-color: #10b981; ring: 2px solid #10b981; }
        textarea.input-field { min-height: 120px; resize: vertical; }

        /* Edit Mode Styles */
        .editable-highlight { 
            border: 2px dashed #F59E0B; cursor: text; border-radius: 4px; position: relative; background-color: rgba(254, 243, 199, 0.3);
        }
        .editable-highlight:hover::after { 
            content: '‚úé Modifier'; position: absolute; top: -20px; right: 0; background: #F59E0B; color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; pointer-events: none; z-index: 50; font-weight: bold;
        }
        .edit-mode-active body { border-top: 4px solid #F59E0B; }

        /* Titles Standardization */
        .section-title { font-size: 1.875rem; line-height: 2.25rem; font-weight: 700; color: #064E3B; margin-bottom: 1rem; }
        
        /* Justify Utility */
        .text-justify { text-align: justify; }

        /* ============================================================
           CSS DU SYST√àME DE MISE √Ä JOUR (Btn + Pop-up What's New)
           ============================================================ */
        
        /* Bouton Refresh */
        #updateContainer {
            position: fixed; bottom: 20px; right: 20px;
            display: flex; align-items: center; justify-content: flex-end;
            z-index: 9999; gap: 10px; font-family: Arial, sans-serif;
        }
        #refreshBtn {
            background-color: #166534; /* Green Codex Dark Green */
            color: white; border: none; border-radius: 50%;
            width: 60px; height: 60px; font-size: 35px; cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3); display: flex;
            justify-content: center; align-items: center; padding: 0; margin: 0;
            line-height: 1; transition: background-color 0.3s, transform 0.2s;
            outline: none; -webkit-tap-highlight-color: transparent; user-select: none;
        }
        #refreshBtn:active { transform: scale(0.95); background-color: #14532d; }
        .update-dot {
            position: absolute; top: 0; right: 0; width: 15px; height: 15px;
            background-color: #ef4444; border-radius: 50%; border: 2px solid white; display: none;
        }
        .rotating { animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #updateAlert { display: none; flex-direction: row; align-items: center; }
        .update-text {
            color: #166534; font-weight: bold; font-size: 14px; margin-right: 5px;
            background: rgba(255,255,255,0.95); padding: 6px 10px; border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .arrow-pointer { font-size: 24px; color: #166534; margin-right: 5px; }
        .bouncing { animation: bounceLeft 0.5s ease-in-out 4; }
        @keyframes bounceLeft { 0%, 100% { transform: translateX(0); } 50% { transform: translateX(-10px); } }

        /* Pop-up What's New */
        #wn-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7); z-index: 10000;
            display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(5px); opacity: 0; transition: opacity 0.3s ease;
        }
        #wn-modal {
            background: white; width: 90%; max-width: 400px; border-radius: 20px;
            padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center;
            position: relative; transform: translateY(20px); transition: transform 0.3s ease;
        }
        .wn-header { margin-bottom: 20px; }
        .wn-badge {
            background-color: #dcfce7; color: #166534; font-size: 10px;
            text-transform: uppercase; font-weight: bold; padding: 4px 8px;
            border-radius: 12px; display: inline-block; margin-bottom: 10px;
        }
        .wn-title { font-size: 22px; font-weight: 900; color: #1f2937; margin: 0; }
        .wn-slides-container {
            height: 200px; display: flex; align-items: center; justify-content: center;
            overflow: hidden; position: relative;
        }
        .wn-slide { display: none; width: 100%; animation: slideIn 0.4s ease forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        .wn-icon { font-size: 50px; margin-bottom: 15px; display: block; }
        .wn-slide-title { font-size: 18px; font-weight: bold; color: #166534; margin-bottom: 10px; display: block; }
        .wn-desc { font-size: 14px; color: #6b7280; line-height: 1.5; }
        .wn-dots { display: flex; justify-content: center; gap: 8px; margin: 20px 0; }
        .wn-dot { width: 8px; height: 8px; background-color: #e5e7eb; border-radius: 50%; transition: background-color 0.3s; }
        .wn-dot.active { background-color: #166534; width: 20px; border-radius: 4px; }
        #wn-btn {
            background-color: #166534; color: white; border: none; width: 100%;
            padding: 15px; border-radius: 12px; font-size: 16px; font-weight: bold;
            cursor: pointer; transition: background-color 0.2s; display: flex;
            justify-content: center; align-items: center; gap: 8px;
        }
        #wn-btn:hover { background-color: #14532d; }
        .show-modal { display: flex !important; opacity: 1 !important; }
        .show-modal #wn-modal { transform: translateY(0) !important; }
        .wn-loader { border: 4px solid #f3f3f3; border-top: 4px solid #166534; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto; }

    </style>
</head>
<body class="text-slate-800 pb-32">

    <!-- HEADER -->
    <header class="bg-gradient-to-r from-emerald-900 to-emerald-700 text-white p-6 shadow-lg sticky top-0 z-50 transition-colors" id="main-header">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div onclick="showView('home')" class="cursor-pointer">
                <h1 class="text-2xl md:text-3xl font-black tracking-tight" data-editable="app_title">GREEN <span class="text-emerald-300">CODEX</span></h1>
                <p class="text-xs md:text-sm text-emerald-200" data-editable="app_subtitle">Encyclop√©die Cannabique & Collection Personnel</p>
            </div>
            <div class="flex gap-2">
                <!-- Bouton INFO ajout√© ici -->
                <button onclick="showView('info')" class="bg-white/10 hover:bg-white/20 text-white w-10 h-10 rounded-lg text-lg font-bold transition flex items-center justify-center border border-white/20">
                    ‚ÑπÔ∏è
                </button>
                
                <button onclick="toggleEditMode()" id="editModeBtn" class="bg-white/10 hover:bg-white/20 text-white px-3 py-2 rounded-lg text-sm font-bold transition flex items-center gap-2 border border-white/20">
                    <span>‚úèÔ∏è</span> <span class="hidden md:inline">Mode √âdition</span>
                </button>
                <button id="navBackBtn" onclick="showView('home')" class="hidden bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg text-sm font-bold transition backdrop-blur-sm">
                    ‚Üê Retour
                </button>
            </div>
        </div>
        <div id="edit-banner" class="hidden w-full bg-amber-500 text-white text-center text-xs font-bold py-1 mt-2 rounded shadow-inner">
            MODE √âDITION ACTIF - Cliquez sur n'importe quel texte pour le modifier.
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 md:p-8 space-y-16">

        <!-- ==================== VIEW: HOME ==================== -->
        <div id="view-home" class="fade-in space-y-16">
            
            <!-- 1. INTRO -->
            <section class="bg-white rounded-2xl shadow-md p-8 border-l-8 border-emerald-600">
                <h2 class="section-title" data-editable="intro_title">L'Odyss√©e de la Plante</h2>
                <div class="text-lg leading-relaxed text-slate-600 space-y-4 text-justify" data-editable="intro_text">
                    <p>L'histoire du Cannabis Sativa L. est une √©pop√©e botanique qui traverse les mill√©naires. Des steppes d'Asie Centrale o√π elle fut domestiqu√©e il y a plus de 10 000 ans, jusqu'aux laboratoires high-tech de Californie, cette plante a fa√ßonn√© des cultures enti√®res.</p>
                    <p>Historiquement, deux grandes traditions s'opposent et se compl√®tent : la culture de la <strong>Fleur (Weed)</strong>, s√©ch√©e et affin√©e pour ses ar√¥mes complexes, et l'art du <strong>Hashish</strong>, n√© au Moyen-Orient et en Asie, qui consiste √† s√©parer m√©caniquement les trichomes pour obtenir un concentr√© pur et stable.</p>
                    <p>Aujourd'hui, nous vivons une renaissance. La science moderne permet de comprendre l'interaction subtile entre cannabino√Ødes et terp√®nes, ouvrant la voie √† des produits d'une puret√© et d'une puissance jamais √©gal√©es.</p>
                </div>
            </section>

            <!-- 2. MY COLLECTION PREVIEW -->
            <section id="my-collection-preview" class="bg-slate-900 rounded-2xl p-8 text-white relative overflow-hidden shadow-xl">
                <div class="absolute top-0 right-0 w-64 h-64 bg-emerald-500 rounded-full blur-[80px] opacity-20 pointer-events-none"></div>
                <div class="relative z-10">
                    <div class="flex justify-between items-end mb-6">
                        <div>
                            <h2 class="text-3xl font-bold text-white mb-2" data-editable="col_title">My Collection</h2>
                            <p class="text-slate-400" data-editable="col_sub">Votre carnet de d√©gustation et d'archivage personnel.</p>
                            <p class="text-xs text-slate-500 mt-1">Source : <span id="dataSourceLabel" class="font-bold">Locale</span></p>
                        </div>
                        <button onclick="showView('collection')" class="bg-emerald-500 hover:bg-emerald-400 text-white px-6 py-3 rounded-xl font-bold transition shadow-lg flex items-center gap-2">
                            <span>üìÇ</span> Ouvrir Portfolio
                        </button>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                            <span class="text-slate-400 text-xs uppercase font-bold">Total Entr√©es</span>
                            <div class="text-3xl font-black text-white" id="stats-total">0</div>
                        </div>
                        <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                            <span class="text-slate-400 text-xs uppercase font-bold">Weeds ü•¶</span>
                            <div class="text-3xl font-black text-emerald-400" id="stats-weed">0</div>
                        </div>
                        <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                            <span class="text-slate-400 text-xs uppercase font-bold">Hashs üç´</span>
                            <div class="text-3xl font-black text-amber-500" id="stats-hash">0</div>
                        </div>
                        <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                            <span class="text-slate-400 text-xs uppercase font-bold">Masse Totale</span>
                            <div class="text-3xl font-black text-purple-400" id="stats-mass">0g</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 3. FAMILLES -->
            <section>
                <div class="mb-8 border-b border-slate-200 pb-4">
                    <h2 class="section-title" data-editable="fam_title">Les Familles Fondamentales</h2>
                    <p class="text-slate-600 max-w-3xl text-justify" data-editable="fam_desc">
                        Le march√© moderne se divise en deux grands royaumes : la fleur brute et les extractions. Chacun poss√®de ses m√©thodes, ses rituels et ses profils aromatiques distincts.
                    </p>
                </div>

                <!-- Hash -->
                <h3 class="text-xl font-bold text-slate-700 mb-4 flex items-center" data-editable="fam_sub1">üß™ Concentr√©s (Hash)</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
                    <div onclick="showDetail('hash_dry')" class="bg-white p-6 rounded-xl shadow-md border-t-4 border-amber-500 card-interactive group">
                        <div class="flex justify-between"> <div class="text-4xl mb-4">üèúÔ∏è</div> <span class="text-xs font-bold text-amber-600 bg-amber-50 px-2 py-1 rounded h-fit">TRADITION</span> </div>
                        <h3 class="text-xl font-bold text-slate-800 group-hover:text-amber-600">Dry Sift</h3>
                        <p class="text-sm text-slate-500 text-justify mt-2">Le tamisage √† sec traditionnel est une technique artisanale d'extraction de r√©sine. En frottant d√©licatement les fleurs s√©ch√©es sur des tamis ultra-fins, 
                            on s√©pare les trichomes de la mati√®re v√©g√©tale. On obtient ainsi un kief pur et savoureux, appr√©ci√© pour sa grande finesse.</p>
                    </div>
                    <div onclick="showDetail('hash_water')" class="bg-white p-6 rounded-xl shadow-md border-t-4 border-blue-500 card-interactive group">
                        <div class="flex justify-between"> <div class="text-4xl mb-4">‚ùÑÔ∏è</div> <span class="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded h-fit">PURET√â</span> </div>
                        <h3 class="text-xl font-bold text-slate-800 group-hover:text-blue-600">Ice-O-Lator</h3>
                        <p class="text-sm text-slate-500 text-justify mt-2">Extraction √† l'eau et glace (Solventless), utilise l'eau glac√©e pour extraire les trichomes. Le froid rend les glandes de r√©sine cassantes, facilitant 
                            leur s√©paration par agitation. Le m√©lange est ensuite filtr√© √† travers plusieurs sacs aux mailles de plus en plus serr√©es pour obtenir de l'Ice-O-Lator ou Bubble Hash.</p>
                    </div>
                    <div onclick="showDetail('hash_rosin')" class="bg-white p-6 rounded-xl shadow-md border-t-4 border-purple-500 card-interactive group">
                        <div class="flex justify-between"> <div class="text-4xl mb-4">üî•</div> <span class="text-xs font-bold text-purple-600 bg-purple-50 px-2 py-1 rounded h-fit">MODERNE</span> </div>
                        <h3 class="text-xl font-bold text-slate-800 group-hover:text-purple-600">Rosin</h3>
                        <p class="text-sm text-slate-500 text-justify mt-2">Une extraction 100 % naturelle obtenue par pression m√©canique. En appliquant simultan√©ment de la chaleur et une forte pression sur des fleurs ou du hash, 
                            on lib√®re une r√©sine pure, collante et ultra-concentr√©e, sans jamais utiliser de solvants chimiques.</p>
                    </div>
                </div>

                <!-- Weed -->
                <h3 class="text-xl font-bold text-slate-700 mb-4 flex items-center" data-editable="fam_sub2">üå± Fleur (Weed)</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div onclick="showDetail('weed_indica')" class="bg-white p-6 rounded-xl shadow-md border-t-4 border-indigo-500 card-interactive group">
                        <div class="flex justify-between"> <div class="text-4xl mb-4">üèîÔ∏è</div> <span class="text-xs font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded h-fit">RELAX</span> </div>
                        <h3 class="text-xl font-bold text-slate-800 group-hover:text-indigo-600">Indica</h3>
                        <p class="text-sm text-slate-500 text-justify mt-2">C'est une vari√©t√© de cannabis originaire des r√©gions montagneuses comme l'Hindou Kouch. Petite et trapue, elle se reconna√Æt √† ses feuilles larges et sombres. 
                            Elle est r√©put√©e pour ses effets relaxants et corporels ("stone"), id√©aux pour apaiser le stress ou favoriser le sommeil.</p>
                    </div>
                    <div onclick="showDetail('weed_sativa')" class="bg-white p-6 rounded-xl shadow-md border-t-4 border-yellow-500 card-interactive group">
                        <div class="flex justify-between"> <div class="text-4xl mb-4">‚òÄÔ∏è</div> <span class="text-xs font-bold text-yellow-600 bg-yellow-50 px-2 py-1 rounded h-fit">√âNERGIE</span> </div>
                        <h3 class="text-xl font-bold text-slate-800 group-hover:text-yellow-600">Sativa</h3>
                        <p class="text-sm text-slate-500 text-justify mt-2">C'est une vari√©t√© originaire des r√©gions tropicales. Grande et √©lanc√©e, elle poss√®de des feuilles fines et des cycles de floraison longs. Elle est recherch√©e 
                            pour ses effets stimulants et c√©r√©braux ("high"), favorisant la cr√©ativit√©, l'√©nergie et la concentration.</p>
                    </div>
                    <div onclick="showDetail('weed_exotic')" class="bg-white p-6 rounded-xl shadow-md border-t-4 border-pink-500 card-interactive group">
                        <div class="flex justify-between"> <div class="text-4xl mb-4">üß¨</div> <span class="text-xs font-bold text-pink-600 bg-pink-50 px-2 py-1 rounded h-fit">HYBRIDE</span> </div>
                        <h3 class="text-xl font-bold text-slate-800 group-hover:text-pink-600">Exotics</h3>
                        <p class="text-sm text-slate-500 text-justify mt-2">Elle d√©signe des vari√©t√©s de cannabis haut de gamme, souvent issues de croisements complexes aux √âtats-Unis. Elles se distinguent par des couleurs vibrantes, 
                            des ar√¥mes intenses et uniques, ainsi qu'une puissance √©lev√©e. C'est le segment ¬´ luxe ¬ª du march√©, privil√©giant la qualit√© visuelle et gustative.</p>
                    </div>
                </div>
            </section>

            <!-- 4. POTENCY & LAYOUT RESTORED -->
            <section class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="section-title" data-editable="potency_title">√âchelle de Puissance</h2>
                    <p class="text-slate-600 mb-4 text-sm text-justify" data-editable="potency_desc">Comparatif des taux moyens de THC observ√©s en laboratoire.</p>
                    <div class="chart-container">
                        <canvas id="potencyChart"></canvas>
                    </div>
                </div>
                <div class="lg:col-span-1 bg-emerald-50 border-l-4 border-emerald-500 p-6 rounded-r-xl">
                    <h4 class="font-bold text-emerald-900 text-lg mb-2" data-editable="didyouknow_title">Le Mythe du THC</h4>
                    <p class="text-sm text-emerald-800 leading-relaxed text-justify" data-editable="didyouknow_text">
                        Attention : un taux de THC √©lev√© (80%+) ne garantit pas une exp√©rience "meilleure". C'est l'<strong>Effet d'Entourage</strong> qui compte : la synergie complexe entre les cannabino√Ødes et les terp√®nes.
                    </p>
                    
                    <p class="text-sm text-emerald-800 leading-relaxed text-justify mt-4" data-editable="didyouknow_text">
                        Par exemple, le <strong>Myrc√®ne</strong> (dominant dans la OG Kush ou un Hash Afghan) ancre la relaxation physique, tandis que le <strong>Limon√®ne</strong> (typique de la Super Lemon Haze) booste l'√©nergie et l'humeur. Le <strong>Caryophyll√®ne</strong> 
                        (Girl Scout Cookies) apporte, lui, un apaisement anti-stress. Cette synergie cr√©e une exp√©rience bien plus riche et nuanc√©e que la puissance brute isol√©e.
                    </p>
                </div>
            </section>

            <!-- 5. COMPARATOR -->
            <section class="bg-white p-8 rounded-2xl shadow-xl border border-slate-100">
                <h2 class="section-title" data-editable="comp_title">Comparateur Interactif</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="space-y-6 flex flex-col justify-center bg-slate-50 p-6 rounded-xl">
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">Produit A</label>
                            <select id="selectA" class="w-full p-3 rounded border border-slate-300 bg-white outline-none" onchange="updateComparator()"></select>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">Produit B</label>
                            <select id="selectB" class="w-full p-3 rounded border border-slate-300 bg-white outline-none" onchange="updateComparator()"></select>
                        </div>
                    </div>
                    <div class="md:col-span-2">
                        <div class="chart-container"><canvas id="comparatorRadar"></canvas></div>
                    </div>
                </div>
            </section>

            <!-- 6. MATRIX -->
            <section class="bg-white p-6 rounded-xl shadow-md">
                <h2 class="section-title" data-editable="matrix_title">Texture vs Puret√©</h2>
                <p class="text-slate-600 mb-4 text-justify" data-editable="matrix_desc">Analyse de la consistance (Solide/Liquide) par rapport √† la concentration en trichomes.</p>
                <div id="globalMatrixPlot" class="w-full h-[500px]"></div>
            </section>

            <!-- 7. LEXICON (RESTORED) -->
            <section class="bg-slate-900 text-slate-300 p-8 rounded-xl">
                <h2 class="section-title !text-white" data-editable="lex_title">Lexique du Connaisseur</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6 text-sm text-justify">
                    <div><strong class="block text-emerald-400 mb-1">Trichomes</strong><span data-editable="lex_1">Les glandes r√©sineuses microscopiques en forme de champignon qui recouvrent la fleur. C'est l'usine chimique de la plante.</span></div>
                    <div><strong class="block text-emerald-400 mb-1">Terp√®nes</strong><span data-editable="lex_2">Compos√©s aromatiques volatils (Limon√®ne, Pin√®ne...). Ils d√©finissent l'odeur et orientent l'effet (s√©datif ou stimulant).</span></div>
                    <div><strong class="block text-emerald-400 mb-1">Full Melt</strong><span data-editable="lex_3">Un gage de puret√© extr√™me pour un hash (souvent Water Hash) qui fond totalement √† la chaleur sans laisser aucun r√©sidu (6 √©toiles).</span></div>
                    <div><strong class="block text-emerald-400 mb-1">Solventless</strong><span data-editable="lex_4">M√©thodes d'extraction m√©caniques utilisant uniquement l'eau, la glace, la chaleur et la pression. Aucune chimie.</span></div>
                    <div><strong class="block text-emerald-400 mb-1">Fresh Frozen</strong><span data-editable="lex_5">Plante congel√©e imm√©diatement apr√®s r√©colte (sans s√©chage) pour pr√©server les terp√®nes volatils "vivants" (Live Resin/Rosin).</span></div>
                    <div><strong class="block text-emerald-400 mb-1">Curing</strong><span data-editable="lex_6">Processus d'affinage lent en bocal herm√©tique. Crucial pour stabiliser l'humidit√© et d√©velopper la complexit√© aromatique.</span></div>
                    <div><strong class="block text-emerald-400 mb-1">Pheno Hunting</strong><span data-editable="lex_7">L'art de s√©lectionner la meilleure plante (le meilleur ph√©notype) parmi des centaines de graines d'une m√™me vari√©t√©.</span></div>
                    <div><strong class="block text-emerald-400 mb-1">Wash</strong><span data-editable="lex_8">Action de laver la mati√®re v√©g√©tale dans de l'eau glac√©e pour en d√©tacher les trichomes (pour faire du Bubble Hash).</span></div>
                </div>
            </section>

            <!-- DYNAMIC SECTIONS -->
            <div id="custom-sections-container" class="space-y-16"></div>

            <!-- ADD SECTION BUTTON -->
            <div id="add-section-area" class="hidden text-center py-10 border-t-2 border-dashed border-slate-300 mt-12">
                <p class="text-slate-400 mb-4 text-sm font-bold uppercase tracking-widest">Zone de Personnalisation</p>
                <button onclick="openSectionModal()" class="bg-amber-500 hover:bg-amber-600 text-white px-8 py-4 rounded-full font-bold shadow-lg transition transform hover:scale-105 mx-auto">
                    + Ajouter une Section
                </button>
            </div>
        </div>


        <!-- ==================== VIEW: DETAIL (ENCYCLOPEDIA) ==================== -->
        <div id="view-detail" class="hidden fade-in space-y-8 pb-12">
            <div id="detail-header" class="bg-white p-8 rounded-2xl shadow-lg border-t-8">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <span id="detail-badge" class="px-3 py-1 rounded-full text-sm font-bold uppercase tracking-wider mb-2 inline-block">Badge</span>
                        <h2 id="detail-title" class="text-4xl md:text-5xl font-black text-slate-800">Title</h2>
                    </div>
                    <div class="text-5xl opacity-20" id="detail-icon">icon</div>
                </div>
                <p id="detail-desc" class="text-lg text-slate-600 leading-relaxed border-l-4 border-slate-200 pl-4 text-justify">Desc</p>
            </div>
            <section class="bg-slate-800 text-white p-8 rounded-2xl shadow-xl">
                <h3 class="text-2xl font-bold mb-6">Processus</h3>
                <div id="detail-flow" class="grid grid-cols-1 md:grid-cols-4 gap-4 text-center"></div>
            </section>
            <section class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <div class="chart-container"><canvas id="detailRadarChart"></canvas></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <div class="chart-container"><canvas id="detailBarChart"></canvas></div>
                </div>
            </section>
        </div>


        <!-- ==================== VIEW: COLLECTION (MANAGER) ==================== -->
        <div id="view-collection" class="hidden fade-in pb-20">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-emerald-900">Mon Portfolio</h2>
                <button onclick="openCollectionForm()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg font-bold shadow-md hover:bg-emerald-500 transition flex items-center gap-2">
                    + Ajouter
                </button>
            </div>
            <div id="collection-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            <div id="empty-state" class="hidden text-center py-20 text-slate-400">
                <div class="text-6xl mb-4">üì≠</div>
                <p>Votre collection est vide.</p>
            </div>
        </div>

        <!-- ==================== VIEW: INFO (NEW) ==================== -->
        <div id="view-info" class="hidden fade-in space-y-8">
            <div class="bg-white p-8 rounded-2xl shadow-lg border-l-8 border-blue-500">
                <h2 class="text-3xl font-black text-slate-800 mb-6 flex items-center gap-3">
                    ‚ÑπÔ∏è Informations Version
                </h2>
                
                <!-- Bloc Version Locale -->
                <div class="bg-slate-50 p-6 rounded-xl border border-slate-200 mb-6">
                    <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">Version Install√©e (Local)</h3>
                    <div class="font-mono text-xl md:text-2xl font-bold text-slate-800 break-all" id="info-local-hash">
                        -
                    </div>
                    <p class="text-sm text-blue-600 mt-2 font-bold" id="info-local-date">
                        Date inconnue
                    </p>
                </div>

                <!-- Bloc Version GitHub -->
                <div class="bg-slate-50 p-6 rounded-xl border border-slate-200">
                    <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">Derni√®re Version (GitHub)</h3>
                    <div class="font-mono text-xl md:text-2xl font-bold text-slate-800 break-all" id="info-remote-hash">
                        V√©rification...
                    </div>
                    <p class="text-xs text-slate-400 mt-2">
                        R√©cup√©r√© en temps r√©el via l'API GitHub
                    </p>
                </div>

                <button onclick="forceUpdate()" class="mt-8 w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-blue-500 transition">
                    Forcer la recherche de mise √† jour
                </button>
            </div>
        </div>

    </main>


    <!-- MODULE DE MISE √Ä JOUR (INJECT√â EN BAS DE PAGE) -->
    <div id="updateContainer">
        <!-- Partie Alerte -->
        <div id="updateAlert">
            <span class="update-text">Mise √† jour üöÄ</span>
            <span class="arrow-pointer">‚ûú</span> 
        </div>
        <!-- Le Bouton -->
        <button id="refreshBtn" onclick="forceUpdate()">
            <div class="update-dot" id="updateDot"></div>
            &#x21bb;
        </button>
    </div>

    <!-- MODULE WHAT'S NEW (POPUP) -->
    <div id="wn-overlay">
        <div id="wn-modal">
            <div class="wn-header">
                <span class="wn-badge">Mise √† jour d√©tect√©e</span>
                <h2 class="wn-title">Quoi de neuf ?</h2>
            </div>
            <div id="wn-content" class="wn-slides-container"><div class="wn-loader"></div></div>
            <div id="wn-dots" class="wn-dots"></div>
            <button id="wn-btn" onclick="nextSlide()" style="display:none">Suivant ‚ûú</button>
        </div>
    </div>


    <!-- MODAL: COLLECTION FORM -->
    <div id="collection-modal" class="hidden fixed inset-0 z-[100] bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl p-6 max-h-[90vh] overflow-y-auto">
            <h3 id="modal-title" class="text-2xl font-bold text-slate-800 mb-6">Ajouter √† la collection</h3>
            <form id="collection-form" onsubmit="handleCollectionSubmit(event)" class="space-y-4">
                <input type="hidden" name="editIndex" id="editIndex" value="-1">
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-slate-500 uppercase">Cat√©gorie</label>
                        <select name="category" id="inp-category" class="input-field" onchange="toggleFormFields(this.value)">
                            <option value="weed">ü•¶ Weed</option>
                            <option value="hash">üç´ Hash</option>
                        </select>
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-slate-500 uppercase">Quantit√© (g)</label>
                        <input type="number" step="0.1" name="quantity" id="inp-quantity" class="input-field" placeholder="ex: 3.5">
                    </div>
                </div>
                <div id="hash-fields" class="hidden bg-amber-50 p-3 rounded-lg border border-amber-100 mb-2">
                    <label class="text-xs font-bold text-amber-600 uppercase mb-1">Type de Hash</label>
                    <input type="text" name="hashType" id="inp-hashType" class="input-field border-amber-200" placeholder="ex: Dry Sift...">
                </div>
                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-500 uppercase">Vari√©t√© (Strain)</label>
                    <input type="text" name="strain" id="inp-strain" class="input-field font-bold" placeholder="ex: Gelato #41" required>
                </div>
                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-500 uppercase">Nom Commercial</label>
                    <input type="text" name="commercialName" id="inp-commercialName" class="input-field" placeholder="ex: Blue Magic">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-slate-500 uppercase">Pays</label>
                        <input type="text" name="country" id="inp-country" class="input-field" placeholder="ex: Pays-Bas">
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-slate-500 uppercase">Prix (‚Ç¨)</label>
                        <input type="number" name="price" id="inp-price" class="input-field" placeholder="ex: 50">
                    </div>
                </div>
                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-500 uppercase">Photos (Max 3)</label>
                    <div class="flex gap-2 items-center">
                        <label class="w-20 h-20 border-2 border-dashed border-slate-300 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:bg-slate-50 transition text-slate-400">
                            <span class="text-2xl">+</span>
                            <input type="file" id="photo-input" class="hidden" accept="image/*" multiple onchange="handlePhotos(this)">
                        </label>
                        <div id="photo-preview-list" class="flex gap-2"></div>
                    </div>
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeCollectionForm()" class="flex-1 py-3 rounded-xl border border-slate-300 text-slate-500 font-bold">Annuler</button>
                    <button type="submit" class="flex-1 py-3 rounded-xl bg-emerald-600 text-white font-bold hover:bg-emerald-500">Sauvegarder</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: SECTION ADD -->
    <div id="section-modal" class="hidden fixed inset-0 z-[100] bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl p-6">
            <h3 class="text-2xl font-bold text-slate-800 mb-6" id="section-modal-title">Ajouter une Section</h3>
            <form id="section-form" onsubmit="handleSectionSubmit(event)" class="space-y-4">
                <input type="hidden" name="secId" id="sec-id">
                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-500 uppercase">Titre</label>
                    <input type="text" name="secTitle" id="sec-title" class="input-field font-bold" required>
                </div>
                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-500 uppercase">Contenu</label>
                    <textarea name="secText" id="sec-text" class="input-field" required></textarea>
                </div>
                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-500 uppercase">Image (Optionnel)</label>
                    <input type="file" id="sec-photo-input" class="input-field" accept="image/*">
                    <div id="sec-current-image" class="mt-2 hidden"><img src="" class="h-20 rounded border"></div>
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeSectionModal()" class="flex-1 py-3 rounded-xl border border-slate-300 text-slate-500 font-bold">Annuler</button>
                    <button type="submit" class="flex-1 py-3 rounded-xl bg-amber-500 text-white font-bold hover:bg-amber-600">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: COLLECTION DETAIL -->
    <div id="collection-detail-modal" class="hidden fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 transition-opacity duration-300">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden max-h-[90vh] flex flex-col animate-fade-in">
            <!-- Header Image Area -->
            <div id="cd-img-container" class="w-full h-64 bg-slate-900 relative flex-shrink-0 group">
                <img id="cd-main-img" class="w-full h-full object-contain">
                <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent pointer-events-none"></div>
                <button onclick="closeCollectionDetail()" class="absolute top-4 right-4 bg-white/20 text-white rounded-full p-2 hover:bg-white/40 backdrop-blur-sm transition">‚úï</button>
                <div id="cd-thumbs" class="absolute bottom-4 left-0 right-0 flex justify-center gap-2 px-4 overflow-x-auto z-10"></div>
            </div>
            
            <!-- Content -->
            <div class="p-6 overflow-y-auto">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 id="cd-strain" class="text-3xl font-black text-slate-800 leading-tight">Strain</h2>
                        <p id="cd-commercial" class="text-emerald-600 font-bold uppercase text-sm tracking-wider mt-1">Commercial</p>
                    </div>
                    <div class="text-5xl" id="cd-flag">üè≥Ô∏è</div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-slate-50 p-3 rounded-xl border border-slate-100 text-center">
                        <span class="text-[10px] uppercase text-slate-400 font-bold block">Quantit√©</span>
                        <span id="cd-quantity" class="text-xl font-black text-slate-700">0g</span>
                    </div>
                    <div class="bg-slate-50 p-3 rounded-xl border border-slate-100 text-center">
                        <span class="text-[10px] uppercase text-slate-400 font-bold block">Prix</span>
                        <span id="cd-price" class="text-xl font-black text-slate-700">0‚Ç¨</span>
                    </div>
                    <div class="bg-slate-50 p-3 rounded-xl border border-slate-100 text-center">
                        <span class="text-[10px] uppercase text-slate-400 font-bold block">Type</span>
                        <span id="cd-category" class="text-lg font-bold text-slate-700">Weed</span>
                    </div>
                    <div class="bg-slate-50 p-3 rounded-xl border border-slate-100 text-center">
                        <span class="text-[10px] uppercase text-slate-400 font-bold block">Date</span>
                        <span id="cd-date" class="text-sm font-bold text-slate-700">...</span>
                    </div>
                </div>

                <div class="space-y-3 text-sm text-slate-600 mb-8 bg-white rounded-xl">
                    <div class="flex justify-between border-b border-slate-100 pb-2">
                        <span>Producteur</span>
                        <span id="cd-farm" class="font-bold text-slate-800">Unknown</span>
                    </div>
                    <div class="flex justify-between border-b border-slate-100 pb-2 hidden" id="cd-hash-row">
                        <span>Technique Hash</span>
                        <span id="cd-hash-type" class="font-bold text-amber-600">-</span>
                    </div>
                    <div class="flex justify-between border-b border-slate-100 pb-2">
                        <span>Origine</span>
                        <span id="cd-country" class="font-bold text-slate-800">-</span>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button id="cd-btn-edit" class="flex-1 py-3 rounded-xl border border-blue-200 text-blue-600 font-bold hover:bg-blue-50 transition">Modifier</button>
                    <button id="cd-btn-delete" class="flex-1 py-3 rounded-xl border border-red-200 text-red-500 font-bold hover:bg-red-50 transition">Supprimer</button>
                </div>
            </div>
        </div>
    </div>


    <script>
        // ============================================================
        // ‚ö†Ô∏è CONFIGURATION GITHUB ‚ö†Ô∏è
        // ============================================================
        
        const GITHUB_USERNAME = 'antoto2021'; 
        // ‚ö†Ô∏è REMPLACEZ 'Green-Codex' PAR LE NOM EXACT DE VOTRE REPO SI DIFF√âRENT
        const GITHUB_REPO     = 'Green-Codex';        
        
        // D√©lai avant v√©rification (1 minute pour le test, peut √™tre augment√©)
        const CHECK_DELAY     = 1 * 60 * 1000; 
        
        // Cl√© de stockage pour le hash de version
        const UPDATE_STORAGE_KEY = 'green_codex_last_hash';
        // Cl√© de stockage pour la date de la derni√®re mise √† jour
        const UPDATE_TIME_KEY    = 'green_codex_update_timestamp';

        // ============================================================

        // --- DATA ---
        const masterData = { hash_dry: { name: "Dry Sift", color: "amber", hex: "#D97706", badge: "Tradition", icon: "üèúÔ∏è", desc: "Tamisage m√©canique ancestral.", process: [{t:"S√©chage",d:"Plante affin√©e"},{t:"Tamisage",d:"Frottement"},{t:"Collection",d:"Poudre"},{t:"Presse",d:"Chaleur"}], radar: [30,90,70,50,60], metrics: [20,50,40,30], metricsLabels: ['Rendement','Puissance','Prix','Tech'], matrix: {x:45,y:9} }, hash_water: { name: "Ice-O-Lator", color: "blue", hex: "#2563EB", badge: "Puret√©", icon: "‚ùÑÔ∏è", desc: "Extraction eau glac√©e + Fresh Frozen.", process: [{t:"Cong√©lation",d:"-40¬∞C"},{t:"Lavage",d:"Eau+Glace"},{t:"Filtre",d:"Sacs"},{t:"S√©chage",d:"Lyophilisation"}], radar: [90,30,60,95,85], metrics: [10,75,90,80], metricsLabels: ['Rendement','Puissance','Prix','Tech'], matrix: {x:70,y:6} }, hash_rosin: { name: "Rosin", color: "purple", hex: "#9333EA", badge: "Excellence", icon: "üî•", desc: "Pression et chaleur uniquement.", process: [{t:"Mat√©riel",d:"Hash 6*"},{t:"Sac",d:"25u Nylon"},{t:"Presse",d:"Hydraulique"},{t:"Cure",d:"Cold Cure"}], radar: [85,50,80,90,95], metrics: [15,85,100,60], metricsLabels: ['Rendement','Puissance','Prix','Tech'], matrix: {x:85,y:3} }, weed_indica: { name: "Indica (Kush)", color: "indigo", hex: "#4F46E5", badge: "Relax", icon: "üèîÔ∏è", desc: "Montagnes, effet lourd.", process: [{t:"Origine",d:"Hindu Kush"},{t:"Structure",d:"Buisson"},{t:"Flo",d:"8 sem"},{t:"Effet",d:"Physique"}], radar: [20,80,90,60,40], metrics: [80,22,50,90], metricsLabels: ['Rendement','THC','Taille','Facilit√©'], matrix: {x:20,y:10} }, weed_sativa: { name: "Sativa (Haze)", color: "yellow", hex: "#D97706", badge: "Energie", icon: "‚òÄÔ∏è", desc: "Tropiques, effet high.", process: [{t:"Origine",d:"Equateur"},{t:"Structure",d:"G√©ante"},{t:"Flo",d:"12+ sem"},{t:"Effet",d:"C√©r√©bral"}], radar: [60,40,20,70,40], metrics: [90,18,100,60], metricsLabels: ['Rendement','THC','Taille','Facilit√©'], matrix: {x:18,y:10} }, weed_exotic: { name: "Exotics", color: "pink", hex: "#DB2777", badge: "Hybride", icon: "üß¨", desc: "Breeding US moderne.", process: [{t:"Origine",d:"Indoor"},{t:"Structure",d:"Optimis√©e"},{t:"Flo",d:"9 sem"},{t:"Effet",d:"Mixte"}], radar: [80,50,60,80,50], metrics: [75,28,60,70], metricsLabels: ['Rendement','THC','Taille','Facilit√©'], matrix: {x:28,y:10} } };

        let collection = JSON.parse(localStorage.getItem('green_codex_collection_v4') || '[]');
        let contentMap = JSON.parse(localStorage.getItem('green_codex_content_v4') || '{}');
        let customSections = JSON.parse(localStorage.getItem('green_codex_custom_sections_v4') || '[]');
        let isEditMode = false;
        let currentPhotos = [];
        let currentSectionImage = null;

        // --- VARIABLES UPDATE ---
        let activeUpdates = [{ icon: "üöÄ", title: "Mise √† jour", desc: "Nouvelle version disponible." }];
        let currentSlide = 0;
        let timerInterval = null;


        // --- CORE FUNCTIONS ---
        function showView(viewId) {
            document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${viewId}`).classList.remove('hidden');
            document.getElementById('navBackBtn').classList.toggle('hidden', viewId === 'home');
            document.getElementById('editModeBtn').classList.toggle('hidden', viewId !== 'home');
            
            // Masquer ou afficher le bouton info selon la vue
            const infoBtn = document.querySelector('button[onclick="showView(\'info\')"]');
            if(infoBtn) infoBtn.style.display = (viewId === 'home' || viewId === 'info') ? 'flex' : 'none';

            window.scrollTo(0,0);
            if(viewId === 'collection') renderCollectionList();
            if(viewId === 'info') renderInfoView();
        }

        // ============================================================
        // SYST√àME DE MISE √Ä JOUR (GITHUB API)
        // ============================================================

        function startUpdateCheckTimer() {
            // V√©rification unique apr√®s 30 secondes √† l'ouverture
            setTimeout(() => {
                checkGitHubStatus();
            }, 30000);
        }

        async function checkGitHubStatus() {
            console.log("üîç V√©rification GitHub...");
            // 1. R√©cup√©rer le hash Distant (GitHub)
            const remoteCommit = await fetchLatestCommit();
            if (!remoteCommit) return;

            const remoteHash = remoteCommit.sha;
            const storedHash = localStorage.getItem(UPDATE_STORAGE_KEY);

            console.log(`Local: ${storedHash ? storedHash.substring(0,7) : 'Aucun'} | Remote: ${remoteHash.substring(0,7)}`);

            // 2. Logique de comparaison
            if (!storedHash) {
                // Cas A : Premier lancement -> on stocke juste l'√©tat actuel et la date
                console.log("Premier lancement ou reset. Sauvegarde du hash.");
                localStorage.setItem(UPDATE_STORAGE_KEY, remoteHash);
                localStorage.setItem(UPDATE_TIME_KEY, Date.now());
            } else if (storedHash !== remoteHash) {
                // Cas B : Diff√©rence d√©tect√©e -> Mise √† jour dispo !
                console.log("‚ö†Ô∏è Mise √† jour disponible !");
                triggerUpdateUI();
                
                // Pr√©-chargement des notes de version
                const parsed = parseCommitMessage(remoteCommit.commit.message);
                if(parsed.length > 0) activeUpdates = parsed;
            } else {
                console.log("‚úÖ Application √† jour.");
            }
        }

        async function handlePostUpdate() {
            console.log("Post-Update d√©tect√© via URL.");

            // 1. R√©cup√©rer le commit distant AVANT d'ouvrir le popup
            const commit = await fetchLatestCommit();
            
            if (!commit) return; 

            const remoteHash = commit.sha;
            const storedHash = localStorage.getItem(UPDATE_STORAGE_KEY);

            // 2. Si le hash local est D√âJ√Ä √©gal au hash distant, c'est que la maj a d√©j√† √©t√© trait√©e
            // On n'affiche pas le popup et on nettoie l'URL
            if (storedHash === remoteHash) {
                console.log("Hash identique (Maj d√©j√† effectu√©e). Suppression du param√®tre URL.");
                const url = new URL(window.location.href);
                url.searchParams.delete('v');
                window.history.replaceState({}, document.title, url.toString());
                return; 
            }

            // 3. Sinon, on affiche le popup
            const overlay = document.getElementById('wn-overlay');
            overlay.style.display = 'flex';
            setTimeout(() => overlay.classList.add('show-modal'), 10);

            // 4. Sauvegarder le NOUVEAU hash comme r√©f√©rence ET la date
            localStorage.setItem(UPDATE_STORAGE_KEY, remoteHash);
            localStorage.setItem(UPDATE_TIME_KEY, Date.now());
            console.log("Nouveau hash sauvegard√© apr√®s maj : " + remoteHash);

            // 5. Remplir le popup
            const parsed = parseCommitMessage(commit.commit.message);
            if (parsed.length > 0) activeUpdates = parsed;

            renderSlides();
            updateSlideUI();
            document.getElementById('wn-btn').style.display = 'flex';
        }

        // --- INFO VIEW LOGIC ---

        async function renderInfoView() {
            // 1. Hash Local
            const localHash = localStorage.getItem(UPDATE_STORAGE_KEY) || 'Aucun';
            document.getElementById('info-local-hash').innerText = localHash.substring(0, 7) + (localHash.length > 7 ? '...' : '');
            
            // 2. Date Locale
            const localTs = localStorage.getItem(UPDATE_TIME_KEY);
            if(localTs) {
                const diff = Date.now() - parseInt(localTs);
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(minutes / 60);
                const days = Math.floor(hours / 24);

                let timeString = "Il y a quelques instants";
                if(days > 0) timeString = `Il y a ${days} jour(s)`;
                else if(hours > 0) timeString = `Il y a ${hours} heure(s)`;
                else if(minutes > 0) timeString = `Il y a ${minutes} minute(s)`;
                
                document.getElementById('info-local-date').innerText = timeString;
            } else {
                document.getElementById('info-local-date').innerText = "Date d'installation inconnue";
            }

            // 3. Remote Hash
            document.getElementById('info-remote-hash').innerText = "Chargement...";
            const remoteCommit = await fetchLatestCommit();
            if(remoteCommit) {
                document.getElementById('info-remote-hash').innerText = remoteCommit.sha.substring(0, 7) + '...';
            } else {
                document.getElementById('info-remote-hash').innerText = "Erreur de connexion";
            }
        }

        // --- OUTILS API GITHUB ---

        async function fetchLatestCommit() {
            if(GITHUB_USERNAME === 'VOTRE_NOM_UTILISATEUR') {
                console.warn("GitHub non configur√© dans le script."); return null;
            }
            try {
                // Ajout d'un timestamp pour √©viter le cache du navigateur
                const response = await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/commits?per_page=1&t=${Date.now()}`);
                if (!response.ok) throw new Error("Erreur API GitHub");
                const data = await response.json();
                return data[0];
            } catch (error) {
                console.error("Erreur check GitHub:", error);
                return null;
            }
        }

        // --- UI UTILS (UPDATE) ---

        function triggerUpdateUI() {
            const dot = document.getElementById('updateDot');
            const alertBox = document.getElementById('updateAlert');
            const arrow = document.querySelector('.arrow-pointer');
            
            // Affiche seulement si pas d√©j√† affich√©
            if(dot.style.display !== 'block') {
                dot.style.display = 'block';
                alertBox.style.display = 'flex';
                arrow.classList.remove('bouncing');
                void arrow.offsetWidth; 
                arrow.classList.add('bouncing');
            }
        }

        function forceUpdate() {
            const btn = document.getElementById('refreshBtn');
            btn.classList.add('rotating');
            setTimeout(() => {
                const baseUrl = window.location.href.split('?')[0];
                // On recharge avec un param√®tre v=timestamp pour forcer le navigateur √† recharger
                // ET d√©clencher le handlePostUpdate au prochain chargement
                window.location.href = baseUrl + '?v=' + Date.now();
            }, 500);
        }

        // --- POPUP SLIDES LOGIC (WHAT'S NEW) ---

        function parseCommitMessage(msg) {
            const lines = msg.split('\n');
            const foundUpdates = [];
            lines.forEach(line => {
                const cleanLine = line.trim();
                // Cherche les lignes commen√ßant par *, +, ou -
                if (cleanLine.match(/^[*+-]\s/)) {
                    let content = cleanLine.substring(2).trim();
                    // Format attendu: "* Titre: Description"
                    const parts = content.split(':');
                    if (parts.length >= 2) {
                        const titlePart = parts[0].trim();
                        const descPart = parts.slice(1).join(':').trim();
                        
                        // Extraction Emoji simple
                        let icon = "‚ú®";
                        let title = titlePart;
                        const emojiRegex = /(\p{Emoji_Presentation}|\p{Extended_Pictographic})/gu;
                        const match = titlePart.match(emojiRegex);
                        if (match && titlePart.indexOf(match[0]) === 0) {
                            icon = match[0];
                            title = titlePart.replace(match[0], '').trim();
                        }
                        foundUpdates.push({ icon, title, desc: descPart });
                    }
                }
            });
            return foundUpdates;
        }

        function renderSlides() {
            const container = document.getElementById('wn-content');
            const dotsContainer = document.getElementById('wn-dots');
            if(activeUpdates.length === 0) {
                container.innerHTML = `<div class="wn-slide" style="display:block"><span class="wn-icon">üöÄ</span><span class="wn-slide-title">Mise √† jour effectu√©e</span><p class="wn-desc">L'application est √† jour.</p></div>`;
                return;
            }
            container.innerHTML = activeUpdates.map((slide, index) => `
                <div class="wn-slide" id="slide-${index}"><span class="wn-icon">${slide.icon}</span><span class="wn-slide-title">${slide.title}</span><p class="wn-desc">${slide.desc}</p></div>
            `).join('');
            dotsContainer.innerHTML = activeUpdates.map((_, index) => `<div class="wn-dot" id="dot-${index}"></div>`).join('');
        }

        function updateSlideUI() {
            document.querySelectorAll('.wn-slide').forEach((el, index) => {
                el.style.display = index === currentSlide ? 'block' : 'none';
            });
            document.querySelectorAll('.wn-dot').forEach((el, index) => {
                if(index === currentSlide) el.classList.add('active');
                else el.classList.remove('active');
            });

            const btn = document.getElementById('wn-btn');
            if (currentSlide === activeUpdates.length - 1) {
                btn.innerHTML = "C'est not√© ‚úÖ";
                btn.style.backgroundColor = "#166534";
            } else {
                btn.innerHTML = "Suivant ‚ûú";
                btn.style.backgroundColor = "#15803d";
            }
        }

        function nextSlide() {
            if (currentSlide < activeUpdates.length - 1) {
                currentSlide++;
                updateSlideUI();
            } else {
                closePopup();
            }
        }

        function closePopup() {
            const overlay = document.getElementById('wn-overlay');
            overlay.classList.remove('show-modal');
            setTimeout(() => {
                overlay.style.display = 'none';
                // Nettoyer l'URL
                const url = new URL(window.location.href);
                url.searchParams.delete('v');
                window.history.replaceState({}, document.title, url.toString());
            }, 300);
        }


        // --- APP LOGIC (Green Codex Legacy) ---
        function compressImage(file, maxWidth = 800, quality = 0.6) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        if (w > maxWidth) { h *= maxWidth / w; w = maxWidth; }
                        canvas.width = w; canvas.height = h;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, w, h);
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        function toggleEditMode() {
            isEditMode = !isEditMode;
            document.body.classList.toggle('edit-mode-active', isEditMode);
            document.getElementById('edit-banner').classList.toggle('hidden', !isEditMode);
            document.getElementById('editModeBtn').classList.toggle('bg-amber-500', isEditMode);
            document.getElementById('add-section-area').classList.toggle('hidden', !isEditMode);
            document.querySelectorAll('[data-editable]').forEach(el => {
                if(isEditMode) { el.classList.add('editable-highlight'); el.onclick = (e) => { e.preventDefault(); e.stopPropagation(); editContent(e.target.closest('[data-editable]')); }; } 
                else { el.classList.remove('editable-highlight'); el.onclick = null; }
            });
            renderCustomSections();
        }

        function editContent(el) {
            if(!isEditMode || !el) return;
            const key = el.getAttribute('data-editable');
            const newText = prompt("Modifier le texte :", el.innerText);
            if(newText !== null && newText !== el.innerText) {
                el.innerText = newText;
                contentMap[key] = newText;
                localStorage.setItem('green_codex_content_v4', JSON.stringify(contentMap));
            }
        }

        function loadSavedContent() {
            document.querySelectorAll('[data-editable]').forEach(el => {
                const key = el.getAttribute('data-editable');
                if(contentMap[key]) el.innerText = contentMap[key];
            });
            renderCustomSections();
        }

        // --- NEW DETAIL MODAL LOGIC ---
        function openCollectionDetail(index) {
            const item = collection[index];
            document.getElementById('cd-strain').innerText = item.strain;
            document.getElementById('cd-commercial').innerText = item.commercialName || item.farm || 'Sans nom';
            document.getElementById('cd-flag').innerText = getFlag(item.country);
            document.getElementById('cd-quantity').innerText = item.quantity + 'g';
            document.getElementById('cd-price').innerText = (item.price || '0') + '‚Ç¨';
            document.getElementById('cd-category').innerText = item.category === 'hash' ? 'Hash üç´' : 'Weed ü•¶';
            document.getElementById('cd-date').innerText = new Date(item.date).toLocaleDateString();
            document.getElementById('cd-farm').innerText = item.farm || item.commercialName || '-';
            document.getElementById('cd-country').innerText = item.country || '-';
            
            if(item.category === 'hash' && item.type) {
                document.getElementById('cd-hash-row').classList.remove('hidden');
                document.getElementById('cd-hash-type').innerText = item.type;
            } else {
                document.getElementById('cd-hash-row').classList.add('hidden');
            }

            // Buttons Logic
            document.getElementById('cd-btn-edit').onclick = () => { closeCollectionDetail(); openCollectionForm(index); };
            document.getElementById('cd-btn-delete').onclick = () => { if(confirm('Supprimer ?')) { collection.splice(index, 1); saveCollection(); closeCollectionDetail(); } };

            // Photos Logic
            const imgContainer = document.getElementById('cd-img-container');
            const mainImg = document.getElementById('cd-main-img');
            const thumbsContainer = document.getElementById('cd-thumbs');
            thumbsContainer.innerHTML = '';

            if (item.photos && item.photos.length > 0) {
                mainImg.src = item.photos[0];
                mainImg.classList.remove('opacity-30', 'p-10'); 
                if (item.photos.length > 1) {
                    item.photos.forEach(src => {
                        const thumb = document.createElement('img');
                        thumb.src = src;
                        thumb.className = "w-12 h-12 rounded-lg border-2 border-white/50 hover:border-emerald-500 cursor-pointer object-cover shadow-md transition transform hover:scale-110";
                        thumb.onclick = () => mainImg.src = src;
                        thumbsContainer.appendChild(thumb);
                    });
                }
            } else {
                mainImg.src = ""; 
            }
            document.getElementById('collection-detail-modal').classList.remove('hidden');
        }

        function closeCollectionDetail() { document.getElementById('collection-detail-modal').classList.add('hidden'); }

        // --- CHARTS ---
        const initCharts = () => { new Chart(document.getElementById('potencyChart'), { type: 'bar', data: { labels: ['Sativa', 'Indica', 'Exotic', 'Dry Sift', 'Ice-O-Lator', 'Rosin', 'BHO'], datasets: [{ label: '% THC', data: [15,20,28,40,65,75,90], backgroundColor: ['#10B981','#10B981','#10B981','#D97706','#2563EB','#9333EA','#64748B'], borderRadius: 4 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: {legend:false} } }); updateComparator(); const trace = { x: Object.values(masterData).map(d => d.matrix.x), y: Object.values(masterData).map(d => d.matrix.y), text: Object.values(masterData).map(d => d.name), mode: 'markers+text', type: 'scatter', textposition: 'top center', marker: { size: 30, color: Object.values(masterData).map(d => d.hex) } }; Plotly.newPlot('globalMatrixPlot', [trace], { xaxis: {title:'Puret√©', range:[0,100]}, yaxis: {title:'Solidit√©', range:[0,12]}, margin:{t:20,l:40}, paper_bgcolor:'rgba(0,0,0,0)', plot_bgcolor:'rgba(0,0,0,0)' }, {displayModeBar:false}); };
        let comparatorChart;
        function updateComparator() { const dA = masterData[document.getElementById('selectA').value || "weed_sativa"], dB = masterData[document.getElementById('selectB').value || "hash_rosin"]; if(comparatorChart) comparatorChart.destroy(); comparatorChart = new Chart(document.getElementById('comparatorRadar'), { type: 'radar', data: { labels: ['Fruit√©', 'Terreux', 'Physique', 'Odeur', 'Intensit√©'], datasets: [ { label: dA.name, data: dA.radar, borderColor: '#3B82F6', backgroundColor: 'rgba(59,130,246,0.2)' }, { label: dB.name, data: dB.radar, borderColor: '#EC4899', backgroundColor: 'rgba(236,72,153,0.2)' } ] }, options: { responsive: true, maintainAspectRatio: false, scales: { r: { suggestedMin:0, suggestedMax:100 } } } }); }
        function showDetail(key) { const d = masterData[key]; showView('detail'); document.getElementById('detail-header').className = `bg-white p-8 rounded-2xl shadow-lg border-t-8 border-${d.color}-500`; document.getElementById('detail-badge').innerText = d.badge; document.getElementById('detail-badge').className = `px-3 py-1 rounded-full text-sm font-bold uppercase mb-2 inline-block bg-${d.color}-100 text-${d.color}-800`; document.getElementById('detail-title').innerText = d.name; document.getElementById('detail-title').className = `text-4xl md:text-5xl font-black text-${d.color}-900`; document.getElementById('detail-icon').innerText = d.icon; document.getElementById('detail-desc').innerText = d.desc; document.getElementById('detail-desc').className = `text-lg text-slate-600 border-l-4 border-${d.color}-200 pl-4 text-justify`; document.getElementById('detail-flow').innerHTML = d.process.map(s => `<div class="bg-slate-700 p-4 rounded-lg border border-slate-600"><div class="text-xs text-${d.color}-400 font-mono uppercase">${s.t}</div><div class="font-bold">${s.d}</div></div>`).join(''); const cvs1 = document.getElementById('detailRadarChart'); const cvs2 = document.getElementById('detailBarChart'); if(cvs1.chart) cvs1.chart.destroy(); if(cvs2.chart) cvs2.chart.destroy(); cvs1.chart = new Chart(cvs1, { type: 'radar', data: { labels: ['Fruit√©','Terreux','Physique','Odeur','Intensit√©'], datasets: [{ label: d.name, data: d.radar, backgroundColor: `${d.hex}33`, borderColor: d.hex, fill: true }] }, options: { maintainAspectRatio: false, plugins: {legend:false} } }); cvs2.chart = new Chart(cvs2, { type: 'bar', data: { labels: ['Rendement','Puissance','Prix','Tech'], datasets: [{ data: d.metrics, backgroundColor: d.hex, borderRadius: 6 }] }, options: { maintainAspectRatio: false, plugins: {legend:false}, scales: {y:{max:100}} } }); }

        // --- COLLECTION ---
        function saveCollection() { try { localStorage.setItem('green_codex_collection_v4', JSON.stringify(collection)); updateDashboardStats(); renderCollectionList(); } catch (e) { alert("Stockage plein."); } }
        function updateDashboardStats() { document.getElementById('stats-total').innerText = collection.length; document.getElementById('stats-weed').innerText = collection.filter(i => i.category === 'weed').length; document.getElementById('stats-hash').innerText = collection.filter(i => i.category === 'hash').length; document.getElementById('stats-mass').innerText = collection.reduce((acc, curr) => acc + (parseFloat(curr.quantity) || 0), 0).toFixed(1) + 'g'; }
        function getFlag(c) { if(!c) return 'üè≥Ô∏è'; const m = {'france':'üá´üá∑','espagne':'üá™üá∏','spain':'üá™üá∏','usa':'üá∫üá∏','cali':'üá∫üá∏','maroc':'üá≤üá¶','morocco':'üá≤üá¶','suisse':'üá®üá≠','italie':'üáÆüáπ','canada':'üá®üá¶','uk':'üá¨üáß','angleterre':'üá¨üáß','allemagne':'üá©üá™','thailande':'üáπüá≠','pays-bas':'üá≥üá±','hollande':'üá≥üá±','netherlands':'üá≥üá±','belgique':'üáßüá™'}; for(let k in m) if(c.toLowerCase().includes(k)) return m[k]; return 'üè≥Ô∏è'; }

        function renderCollectionList() {
            const container = document.getElementById('collection-list');
            container.innerHTML = '';
            document.getElementById('empty-state').classList.toggle('hidden', collection.length > 0);
            collection.forEach((item, index) => {
                const photosHtml = item.photos && item.photos.length ? `<img src="${item.photos[0]}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-3xl opacity-30">${item.category==='hash'?'üç´':'ü•¶'}</div>`;
                const html = `
                <div onclick="openCollectionDetail(${index})" class="bg-white rounded-xl shadow-sm border border-slate-100 p-4 flex gap-4 relative group hover:border-emerald-300 transition cursor-pointer">
                    <div class="w-20 h-20 rounded-lg bg-slate-100 flex-shrink-0 overflow-hidden relative">
                        ${photosHtml}
                        ${item.photos && item.photos.length > 1 ? `<span class="absolute bottom-0 right-0 bg-black/50 text-white text-[10px] px-1">+${item.photos.length-1}</span>` : ''}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-start">
                            <h3 class="font-bold text-slate-800 truncate pr-2">${item.strain}</h3>
                            <span class="text-xl">${getFlag(item.country)}</span>
                        </div>
                        <p class="text-xs text-slate-500 font-bold uppercase mb-1">${item.commercialName || item.farm || 'Inconnu'}</p>
                        ${item.type ? `<span class="bg-amber-100 text-amber-800 text-[10px] px-1.5 py-0.5 rounded border border-amber-200 block w-fit mb-1">${item.type}</span>` : ''}
                        <div class="flex items-center gap-2 mt-2">
                             <span class="bg-emerald-50 text-emerald-700 text-xs px-2 py-1 rounded font-bold">${item.quantity}g</span>
                             <div class="ml-auto flex gap-1">
                                <button onclick="event.stopPropagation(); openCollectionForm(${index})" class="text-blue-400 hover:text-blue-600 p-1"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                                <button onclick="event.stopPropagation(); deleteItem(${index})" class="text-red-400 hover:text-red-600 p-1"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                             </div>
                        </div>
                    </div>
                </div>`;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        // --- FORMS ---
        function openCollectionForm(editIndex = -1) {
            const form = document.getElementById('collection-form'); form.reset();
            document.getElementById('editIndex').value = editIndex;
            document.getElementById('modal-title').innerText = editIndex === -1 ? "Ajouter" : "Modifier";
            currentPhotos = [];
            if(editIndex > -1) {
                const item = collection[editIndex];
                document.getElementById('inp-category').value = item.category;
                document.getElementById('inp-quantity').value = item.quantity;
                document.getElementById('inp-strain').value = item.strain;
                document.getElementById('inp-commercialName').value = item.commercialName;
                document.getElementById('inp-country').value = item.country;
                if(item.farm) document.getElementById('inp-commercialName').value = item.farm; // Backwards compatibility
                document.getElementById('inp-price').value = item.price;
                if(item.type) document.getElementById('inp-hashType').value = item.type;
                toggleFormFields(item.category);
                if(item.photos) currentPhotos = [...item.photos];
            } else { toggleFormFields('weed'); }
            renderPhotoPreviews();
            document.getElementById('collection-modal').classList.remove('hidden');
        }
        function closeCollectionForm() { document.getElementById('collection-modal').classList.add('hidden'); }
        function toggleFormFields(cat) { document.getElementById('hash-fields').classList.toggle('hidden', cat !== 'hash'); }
        async function handlePhotos(input) { if (input.files) { const rem = 3 - currentPhotos.length; if(rem <= 0) { alert("Max 3 photos !"); return; } const files = Array.from(input.files).slice(0, rem); for (const file of files) { try { const compressed = await compressImage(file); currentPhotos.push(compressed); } catch(e) {} } renderPhotoPreviews(); } }
        function removePhoto(idx) { currentPhotos.splice(idx, 1); renderPhotoPreviews(); }
        function renderPhotoPreviews() { document.getElementById('photo-preview-list').innerHTML = currentPhotos.map((src, i) => `<div class="w-20 h-20 rounded-xl relative overflow-hidden group"><img src="${src}" class="w-full h-full object-cover"><button type="button" onclick="removePhoto(${i})" class="absolute top-0 right-0 bg-red-500 text-white text-xs p-1 opacity-0 group-hover:opacity-100">X</button></div>`).join(''); }
        function handleCollectionSubmit(e) {
            e.preventDefault(); const f = new FormData(e.target); const idx = parseInt(document.getElementById('editIndex').value);
            const item = { category: f.get('category'), quantity: f.get('quantity'), strain: f.get('strain'), commercialName: f.get('commercialName'), type: f.get('hashType'), country: f.get('country'), price: f.get('price'), photos: currentPhotos, date: new Date().toISOString() };
            if(idx > -1) collection[idx] = item; else collection.unshift(item);
            saveCollection(); closeCollectionForm();
        }
        function deleteItem(index) { if(confirm('Supprimer ?')) { collection.splice(index, 1); saveCollection(); } }

        // --- SECTIONS ---
        function openSectionModal(id=null) { document.getElementById('section-form').reset(); document.getElementById('sec-current-image').classList.add('hidden'); currentSectionImage=null; if(id) { const s=customSections.find(x=>x.id===id); document.getElementById('sec-id').value=s.id; document.getElementById('sec-title').value=s.title; document.getElementById('sec-text').value=s.text; if(s.image){ currentSectionImage=s.image; document.querySelector('#sec-current-image img').src=s.image; document.getElementById('sec-current-image').classList.remove('hidden'); } } document.getElementById('section-modal').classList.remove('hidden'); }
        function closeSectionModal() { document.getElementById('section-modal').classList.add('hidden'); }
        async function handleSectionSubmit(e) { e.preventDefault(); const f=e.target; const id=f.secId.value?parseInt(f.secId.value):Date.now(); const file=document.getElementById('sec-photo-input').files[0]; if(file) currentSectionImage=await compressImage(file); const s={id, title:f.secTitle.value, text:f.secText.value, image:currentSectionImage}; const i=customSections.findIndex(x=>x.id===id); if(i>-1) customSections[i]=s; else customSections.push(s); localStorage.setItem('green_codex_custom_sections_v4',JSON.stringify(customSections)); renderCustomSections(); closeSectionModal(); }
        function deleteCustomSection(id) { if(confirm('Supprimer ?')) { customSections=customSections.filter(x=>x.id!==id); localStorage.setItem('green_codex_custom_sections_v4',JSON.stringify(customSections)); renderCustomSections(); } }
        function renderCustomSections() { document.getElementById('custom-sections-container').innerHTML = customSections.map((s,i) => `<section class="bg-white rounded-2xl shadow-md p-8 border-l-8 border-emerald-600 relative group animate-fade-in text-justify">${isEditMode?`<div class="absolute top-4 right-4 flex gap-2"><button onclick="openSectionModal(${s.id})" class="text-blue-500 font-bold border border-blue-200 px-3 py-1 rounded hover:bg-blue-50 text-xs">Modifier</button><button onclick="deleteCustomSection(${s.id})" class="text-red-500 font-bold border border-red-200 px-3 py-1 rounded hover:bg-red-50 text-xs">Supprimer</button></div>`:''}<h2 class="section-title">${i+8}. ${s.title}</h2>${s.image?`<img src="${s.image}" class="w-full max-h-96 object-cover rounded-xl mb-6 shadow-sm">`:''}<div class="text-lg leading-relaxed text-slate-600 whitespace-pre-wrap">${s.text}</div></section>`).join(''); }

        // INIT
        window.addEventListener('load', () => { 
            const urlParams = new URLSearchParams(window.location.search);
            const isPostUpdate = urlParams.has('v');

            // 1. Initialiser les graphiques Green Codex
            initCharts(); 
            loadSavedContent(); 
            updateDashboardStats(); 
            
            // Populate Selects
            const sA = document.getElementById('selectA'), sB = document.getElementById('selectB');
            Object.keys(masterData).forEach(k => { sA.add(new Option(masterData[k].name, k)); sB.add(new Option(masterData[k].name, k)); });
            sA.value = "weed_sativa"; sB.value = "hash_rosin"; updateComparator();

            // 2. D√©marrer le syst√®me de mise √† jour
            startUpdateCheckTimer();

            // 3. Gestion Post-Update (Pop-up)
            if (isPostUpdate) {
                handlePostUpdate();
            }
        });
    </script>
</body>
</html>

